pipeline {
  agent any

  environment {
    AWS_REGION = "ap-south-1"
    CLUSTER_NAME = "education-eks-HDxqSq"
    CHART_DIR = "chart/my-java-app"
    RELEASE_NAME = "my-java-app"
    IMAGE_REPO = "vandu0409/my-java-app"
    IMAGE_TAG = "latest"
  }

  stages {
    stage('Checkout Code') {
      steps {
        git branch: 'master',
            credentialsId: 'github-cred',
            url: 'https://github.com/Vandu0409/jenkins.git'
      }
    }

    stage('Connect to EKS') {
      steps {
        script {
          echo "Connecting to EKS Cluster: ${CLUSTER_NAME} in ${AWS_REGION}"

          // Use either IAM Role (EC2) or AWS creds
          withAWS(credentials: 'aws-creds', region: "${AWS_REGION}") {
            sh '''
              aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
              kubectl get nodes
            '''
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          docker build -t ${IMAGE_REPO}:${IMAGE_TAG} .
        '''
      }
    }

    stage('Push Docker Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-registry-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh '''
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker push ${IMAGE_REPO}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Deploy to EKS with Helm') {
      steps {
        script {
          sh '''
            helm upgrade --install ${RELEASE_NAME} ${CHART_DIR} \
              --set image.repository=${IMAGE_REPO} \
              --set image.tag=${IMAGE_TAG} \
              --set service.port=5000 \
              --set service.targetPort=5000 \
              --namespace default --create-namespace --wait --timeout 5m
          '''
        }
      }
    }

    stage('Verify Deployment') {
      steps {
        sh '''
          kubectl get pods -n default
          kubectl get svc -n default
        '''
      }
    }
  }
}
