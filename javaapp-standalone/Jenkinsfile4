pipeline {

    agent any

    environment {
        AWS_REGION     = "ap-south-1"
        ACCOUNT_ID     = "905418283021"
        REPO_NAME      = "javaapp"
        IMAGE_TAG      = "${BUILD_NUMBER}"
        ECR_REPO       = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${REPO_NAME}"

        K8S_NAMESPACE  = "javaapp"
        RELEASE_NAME   = "javaapp"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'k8s-jenkinspod',
                    url: 'https://github.com/Vandu0409/jenkins.git'
            }
        }

        stage('Build Java App') {
            steps {
                dir('javaapp-standalone') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                        docker build -t ${ECR_REPO}:${IMAGE_TAG} ./javaapp-standalone
                    """
                }
            }
        }

        stage('Login & Push to ECR') {
            steps {
                script {
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} \
                        | docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

                        docker push ${ECR_REPO}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy to Kubernetes via Helm') {
            steps {
                script {

                    sh """
                        # Create namespace if not exists
                        kubectl get ns ${K8S_NAMESPACE} || kubectl create ns ${K8S_NAMESPACE}

                        # Deploy using Helm
                        helm upgrade --install ${RELEASE_NAME} ./javaapp-helm \
                          --namespace ${K8S_NAMESPACE} \
                          --set image.repository=${ECR_REPO} \
                          --set image.tag=${IMAGE_TAG}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "��� Deployment Successful! Java App deployed with tag ${IMAGE_TAG}"
        }
        failure {
            echo "❌ Deployment Failed. Check logs!"
        }
    }
}

