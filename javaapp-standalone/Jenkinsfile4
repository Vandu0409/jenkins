pipeline {
  agent none

  // Prevent Jenkins from doing the automatic "Checkout SCM" step
  options {
    skipDefaultCheckout()
  }

  environment {
    DOCKERHUB_USER = "vandu0409"
    IMAGE_REPO     = "vandu0409/javaapp"
    IMAGE_TAG      = "${BUILD_NUMBER}"

    K8S_NAMESPACE  = "javaapp"
    RELEASE_NAME   = "javaapp"
  }

  stages {

    stage('Build, Build Image & Deploy (single pod)') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:

  - name: builder
    image: maven:3.9.6-eclipse-temurin-21
    command: ['sleep']
    args: ['999999']
    volumeMounts:
      - name: workspace
        mountPath: /home/jenkins/agent

  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ['sleep']
    args: ['999999']
    volumeMounts:
      - name: workspace
        mountPath: /home/jenkins/agent
      - name: docker-config
        mountPath: /kaniko/.docker/

  - name: helm
    image: alpine/helm:3.11.2
    command: ['sleep']
    args: ['999999']
    volumeMounts:
      - name: workspace
        mountPath: /home/jenkins/agent

  volumes:
    - name: workspace
      emptyDir: {}

    - name: docker-config
      secret:
        secretName: regcred
        items:
        - key: .dockerconfigjson
          path: config.json
"""
        }
      }

      stages {
        stage('Git clone inside builder') {
          steps {
            container('builder') {
              // Use git clone here to force git to run inside the builder container
              sh '''
                set -eux
                # ensure workspace is clean
                rm -rf ./*
                # clone the required branch into the pod workspace
                git clone -b k8s-jenkins https://github.com/Vandu0409/jenkins.git .
                echo "Repository contents:"
                ls -la
              '''
            }
          }
        }

        stage('Build JAR') {
          steps {
            container('builder') {
              sh '''
                set -eux
                cd javaapp-standalone
                mvn clean package -DskipTests
                echo "Target files:"
                ls -la target || true
              '''
            }
          }
        }

        stage('Build Docker Image (Kaniko)') {
          steps {
            container('kaniko') {
              sh '''
                set -eux
                # Kaniko context should be the repo root (workspace) or specific folder
                # we built the jar inside javaapp-standalone so use that folder as context
                /kaniko/executor \
                  --dockerfile=javaapp-standalone/Dockerfile \
                  --context=$(pwd)/javaapp-standalone \
                  --destination=docker.io/${IMAGE_REPO}:${IMAGE_TAG}
              '''
            }
          }
        }

        stage('Deploy to Kubernetes via Helm') {
          steps {
            container('helm') {
              sh '''
                set -eux
                helm upgrade --install ${RELEASE_NAME} javaapp-standalone/chart/my-java-app \
                  --namespace ${K8S_NAMESPACE} \
                  --set image.repository=docker.io/${IMAGE_REPO} \
                  --set image.tag=${IMAGE_TAG}
              '''
            }
          }
        }
      } // end inner stages
    } // end top stage
  } // end stages

  post {
    success {
      echo "üéâ Deployment Successful! VERSION=${IMAGE_TAG}"
    }
    failure {
      echo "‚ùå Deployment Failed. Check logs!"
    }
  }
}
