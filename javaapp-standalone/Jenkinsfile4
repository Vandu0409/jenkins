pipeline {

  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ["/busybox/sleep"]
    args: ["999999"]
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker/

  volumes:
  - name: docker-config
    secret:
      secretName: regcred
      items:
      - key: .dockerconfigjson
        path: config.json
"""
    }
  }

  stages {

    stage('Clone Repository') {
      steps {
        container('kaniko') {
          sh """
            echo "===== Cloning Repo Inside Kaniko Container ====="
            git clone https://github.com/Vandu0409/jenkins.git src
            ls -l src
          """
        }
      }
    }

    stage('Build JAR') {
      steps {
        container('kaniko') {
          sh """
            echo "===== Installing Maven inside Kaniko ====="
            apk add --no-cache maven

            cd src/javaapp-standalone

            echo "===== Running Maven Package ====="
            mvn clean package -DskipTests

            echo "===== JAR Built ====="
            ls -l target
          """
        }
      }
    }

    stage('Build Docker Image with Kaniko') {
      steps {
        container('kaniko') {
          sh """
            echo "===== Creating Dockerfile ====="
            cd src/javaapp-standalone

            cat > Dockerfile <<EOF
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY target/java-sample-21-1.0.0.jar app.jar
ENTRYPOINT ["java","-jar","app.jar"]
EOF

            echo "===== Running Kaniko ====="

            /kaniko/executor \
              --dockerfile=Dockerfile \
              --context=`pwd` \
              --destination=docker.io/vandu0409/javaapp:${BUILD_NUMBER}
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('kaniko') {
          sh """
            echo "===== Installing Helm ====="
            apk add --no-cache curl tar gzip

            curl -sSL https://get.helm.sh/helm-v3.11.2-linux-amd64.tar.gz -o helm.tgz
            tar -xzf helm.tgz
            mv linux-amd64/helm /usr/local/bin/helm

            echo "===== Running Helm Upgrade ====="

            helm upgrade --install javaapp src/javaapp-standalone/chart/my-java-app \
              --namespace javaapp \
              --set image.repository=docker.io/vandu0409/javaapp \
              --set image.tag=${BUILD_NUMBER}
          """
        }
      }
    }

  }

  post {
    success {
      echo "ðŸŽ‰ Deployment Successful â€” Version ${BUILD_NUMBER}"
    }
    failure {
      echo "âŒ Deployment Failed"
    }
  }
}
